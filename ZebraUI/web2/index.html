<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/style.css" type="text/css">
    <link rel="stylesheet" href="/css/jquery-ui.min.css" type="text/css">
    <link rel="stylesheet" href="/css/jquery-ui.structure.min.css" type="text/css">
    <link rel="stylesheet" href="/css/jquery-ui.theme.min.css" type="text/css">
    <link rel="stylesheet" href="/semantic/dist/semantic.min.css" type="text/css">
    <title>ZebraTester</title>
</head>
<body>
   <div class="ui fluid container">
      <div class="ui hidden divider"></div>
       <div class="ui massive attached tabular menu">
           <div class="divider"></div>
             <div class="ui middle aligned spaced medium image">
              <img src="img/logga.png">
            </div>
            <div class="right menu">
                <a class="active item" data-tab="build" data-vivaldi-spatnav-clickable="1">Build</a>
                <a class="item" data-tab="run" data-vivaldi-spatnav-clickable="1">Run</a>
                <a class="item" data-tab="analyze" data-vivaldi-spatnav-clickable="1">Analyze</a>
                <a class="item" data-tab="empty" data-vivaldi-spatnav-clickable="1"></a>
            </div>
       </div>
       <div class="ui bottom attached active tab segment" data-tab="build">
            <div class="ui menu">
                <div class="ui dropdown link item">
                    <i class="list icon"></i>
                    <span class="text">Menu</span>
                    <div class="menu">
                        <div class="header">File</div>
                        <div id="newScriptButton" class="item"><span class="text">New script...</span></div>
                        <div id="openScriptButton" class="item">Open...</div>
                        <div id="saveScriptButton" class="item"><span class="text">Save</span></div>
                        <div id="saveAsScriptButton" class="item">Save as...</div>
                        <div class="divider"></div>
                        <div class="header">Load Test</div>
                        <div class="item">Quick Test</div>
                        <div class="item">Generate Load Test</div>
                        <div class="divider"></div>
                        <div class="item">Clear Session</div>
                    </div>
                </div>
                <div class="ui dropdown link item">
                    <i class="book icon"></i>
                    <span class="text">View</span>
                    <div class="menu">
                        <div class="header">Panels</div>
                        <div class="item"><span class="text">Toggle Var Handler</span></div>
                        <div id='toggleRecorder' class="item">Toggle Recorder</div>
                        <div class="item">Toggle Project Navigator</div>
                        <div class="divider"></div>
                        <div class="header">Display</div>
                        <div class="item">Original Item Numbers</div>
                        <div class="item">Current Item Numbers</div>
                        <div class="item">Runtime Configuration</div>
                        <div class="item">Item Offset</div>
                        <div class="item">Content Type</div>
                        <div class="item">Content Verification</div>
                    </div>
                </div>
                <div class="ui dropdown link item">
                    <i class="filter icon"></i>
                    <span class="text">Filter items</span>
                    <div class="menu">      
                        <div class="header">Sort by</div>
                        <div class="item">Host</div>
                        <div class="item">Content Type</div>
                        <div class="item">Status Code</div>
                        <div class="divider"></div>
                        <div class="header">Exclude</div>
                        <div class="item">Static Content</div>
                        <div class="item">Cached Content</div>
                        <div class="divider"></div>
                        <div class="item">Clear Filter</div>
                    </div>
                </div>
                
                <div class="right menu">
                   <div id="recorderTrigger" class="link item">Recorder</div>
                   <div id="recorderToolbar" class="ui popup fluid wide">
                    <div class="ui menu">
                     <div id="record" class="link item">
                         Start Recording
                    </div>
                    <div id="pageBreaker" class="item">
                         <div class="ui input">
                            <input type="text" placeholder="Add PageBreak...">
                          </div>
                    </div>
                    <div id="clearRecord" class="link item">
                         Clear Recording
                    </div>
                    </div>
                    </div>
                    <div class="item">
                         <div class="ui icon input">
                            <input type="text" placeholder="Search...">
                            <i class="search link icon"></i>
                          </div>
                    </div>
                </div>
            </div>
            <div id="listView" class="item">
            <div id="metaDataView" class="ui basic segment">
            </div>
            <div id="pageBreakSegments" class="ui segments">
            </div>
            </div>
           
           </div>
            
        <div class="ui bottom attached tab segment" data-tab="run">
            Run
        </div>
        <div class="ui bottom attached tab segment" data-tab="analyze">
            Analyze
        </div>
   </div>
    <script src="/js/jquery-3.1.1.min.js" type="application/javascript"></script>
    <script src="/js/jquery-ui.min.js" type="application/javascript"></script>
    <script src="/semantic/dist/semantic.min.js" type="application/javascript"></script>
    <script src="/js/handlebars-v4.0.5.js" type="application/javascript"></script>
    <script>
        $(document).ready(function(e) {  
            $.ajax({url: "prxMetaData", success: function(result){
                $('#metaDataView')
                    .replaceWith
                (renderProjectMetaData(result));
                $('#pageBreakSegments')
                    .html(renderList(result));
                $('.ui.accordion').accordion({
                    duration: 500
                });
                var $toggle  = $('.ui.toggle.button');
                $toggle.state({text: {inactive : 'S',active   : 'P'}});
                $("div[id^='urlSegments']").sortable({
                    connectWith: "div#urlSegments.ui.segments", 
                    placeholder: "ui-state-highlight",
                    handle: ".title"
                });
                $("div[id^='pageBreakSegments']").sortable({
                    connectWith: "div#pageBreakSegments.ui.segments", 
                    placeholder: "ui-state-highlight",
                    handle: ".title"
                });
            }});
            $.fn.toggleClick = function(){
                var methods = arguments, // store the passed arguments for future reference
                    count = methods.length; // cache the number of methods 

                //use return this to maintain jQuery chainability
                return this.each(function(i, item){
                    // for each element you bind to
                    var index = 0; // create a local counter for that element
                    $(item).click(function(){ // bind a click handler to that element
                        return methods[index++ % count].apply(this,arguments); // that when called will apply the 'index'th method to that element
                        // the index % count means that we constrain our iterator between 0 and (count-1)
                    });
                });
            };
            
            //Handles toggling of the recorder
            $('#record').toggleClick(function(){
                $(this).addClass('recording');
                $(this).text('Stop Recording  ');
                $.ajax({url:'startRecording', success: function(result){
                    console.log("Recording started successfully");
                }});
            },function(){
                $(this).removeClass('recording');
                $(this).text('Start Recording');
                $.ajax({url:'stopRecording', success: function(result){
                    console.log("Recording stopped successfully");
                }});
            });
            
            //Clears recording
            $('#clearRecord').click(function(){
                $.ajax({url:'clearRecording', success: function(result){
                    console.log("Recording cleared successfully");
                }});
            });
            
            
            /*var $toggleRecord = $('#record');
            $toggle.state({text: {inactive: "Start recording", active: 'Stop Recording'}});*/
            
            $('#recorderTrigger')
              .popup({
                popup : $('.popup'),
                on    : 'click',
                position : 'bottom right'
              });
            $('.right.menu .item').tab();
            $('.dropdown').dropdown({action: 'select'});
            
            //Render the metaData of the Project
            function renderProjectMetaData(result){
                var output;
                
                output='<div class="ui grid">'+
                    '<div class="ten wide column"><h3 id="projectNameLabel" class="ui left aligned header">'+result.projectName+
                    '<div class="sub header">Script Name</div></h3></div>'+
                    '<div class="two wide column"><h3 id="projectURLCount" class="ui center aligned header">'+
                    countURLCalls(result)+
                    '<div class="sub header">Number of<br>URL calls</div></h3></div>'+
                    '<div class="two wide column"><h3 id="projectSentSize" class="ui center aligned header">'+
                    calculateTotalRequestSize(result)+
                    '<div class="sub header">Total Size<br> Sent</div></h3></div>'+
                    '<div class="two wide column"><h3 id="projectRecievedSize" class="ui center aligned header">'+
                    calculateTotalResponseSize(result)+
                    '<div class="sub header">Total Size<br> Recieved</div></h3></div>'+
                    '</div>'
                
                console.log(result);
                
                return output;
            }
            
            //Counts number of URL calls
            function countURLCalls(result){
                var count=0;
        
                for(var i = 0; i<result.proxyData.length; ++i){
                    var record=result.proxyData[i];
                    if ("httpRequest" in record){
                        count=count+1;
                    }
                    
                }
                
                return count;
            } 
            
            
            //Selects the correct label for content type
            function pickContentLabel (contentType){
                var label;
                if(typeof contentType === 'undefined'){
                   label='<div id="contentTypeLabel" class="ui medium black label">N/A</div>'; 
                }else if (contentType.includes('TEXT/HTML')){
                    label='<div id="contentTypeLabel" class="ui medium blue label">HTML</div>';
                }else if (contentType.includes('TEXT/CSS')){
                    label='<div id="contentTypeLabel" class="ui medium red label">CSS</div>';
                }else if (contentType.includes('APPLICATION/X-JAVASCRIPT')|| contentType.includes('APPLICATION/JAVASCRIPT')){
                    label='<div id="contentTypeLabel" class="ui medium olive label">JS</div>';
                }else if (contentType.includes('APPLICATION/JSON')){
                    label='<div id="contentTypeLabel" class="ui medium green label">JSON</div>';
                }else if (contentType.includes('IMAGE')){
                    label='<div id="contentTypeLabel" class="ui medium orange label">IMAGE</div>';
                }else{
                    label='<div id="contentTypeLabel" class="ui medium grey label">OTHER</div>';
                }
                return label;
            }
            
            //Chooses the correct HTTP Response code
            function pickStatusCode(statusCode, statusMessage){
                var statusLabel = '<b>'+statusCode+' '+statusMessage+'</b>';
                return statusLabel;
            }
            
            //Renders the list of URL calls and page breaks
            function renderList (data){
                var html='';
                var dataArray = data.proxyData;
                
                for (var i = 0; i < dataArray.length;++i){
                    var proxyRecord = dataArray[i];

                    if ('httpPageBreak' in proxyRecord){
                        if (i>0){
                            html += '</div></div></div></div>';
                        }
                        html += '<div id="pageBreakSegment'+i+'" pageBreakID="'+ i +
                            '" class="ui segment">'+'<div class="ui fluid accordion">'+
                        '<div class="title">'+proxyRecord.httpPageBreak.comment+'</div>'+
                        '<div class="content"><div id="urlSegments" class="ui segments">';
                    }
                    else{
                        html += '<div id="urlSegment"urlID="'+i+'" class="ui segment">'+
                            '<div class="item"><button id="serialParallelButton" class="ui tiny right floated toggle button">S</button></div>'+
                            '<div class="item" id="urlSizeText"><b>'+calculatePageSize(proxyRecord.httpResponse.headerContentLength)+'</b></div>'+
                            '<div class="accordion" urlIDAccordion="'+i+'">'+
                            '<div class="title">'+
                            pickContentLabel(proxyRecord.httpResponse.headerContentType)+
                            pickStatusCode(proxyRecord.httpResponse.headerServerStatus, proxyRecord.httpResponse.headerServerStatusText)+
                            ' '+
                            proxyRecord.httpRequest.urlProtocol+
                            '://'+proxyRecord.httpRequest.urlHost+proxyRecord.httpRequest.urlFile+'</div>'+'<div class="content">'+
                            renderURLCall(proxyRecord, i)+
                            '</div>'+
                            '</div></div>';
                            
                            
                    }
                    
                }
                html += '</div></div></div></div>';
                return html;
            }
            
            //Calculates the totalResponseSize
            function calculateTotalResponseSize(result){
                var contentSize=0;
                
                for (var i = 0; i<result.proxyData.length; ++i){
                    var record = result.proxyData[i];
                    if ("httpResponse" in record){
                        contentSize=contentSize+record.httpResponse
                            .headerContentLength;
                    }
                }
                
                return calculatePageSize(contentSize);
            }
            
            //Calculates the totalRequestSize
            function calculateTotalRequestSize(result){
                var contentSize=0;
                
                for (var i = 0; i<result.proxyData.length; ++i){
                    var record = result.proxyData[i];
                    if ("httpRequest" in record){
                        contentSize=contentSize+record.httpRequest
                            .requestTransmitSize;
                    }
                }
                
                return calculatePageSize(contentSize);
            }
            
            //Calculates the response content size
            function calculatePageSize(headerContentLength){
                
                var sizeB=headerContentLength;
                var sizeKB = headerContentLength/1024;
                var sizeMB = sizeKB/1024;
                
                if (sizeKB>1024){
                    return Math.round(sizeMB * 10)/10 + ' MB';
                }else if(sizeKB<1){
                    return Math.round(sizeB * 10)/10 + ' B';
                }else{
                    return Math.round(sizeKB * 10)/10 + ' KB';
                }
            }
            
            //Renders individual data for URL call
            function renderURLCall (urlCall, index){
                var output='';
                
                output+='<div class="ui two column grid">'+
                    '<div class="row">'+
                    '<div class="column">'+
                    '<div id="urlSegmentGroup" class="ui segments">'+
                    '<div id="requestHeaderHead" class="ui attached yellow inverted segment">'+
                    '<div class="ui medium header">Request Header</div></div>'+
                    renderRequestHeaders(urlCall.httpRequest.header)+'</div></div>'+
                    renderRequestContent(urlCall.httpRequest)+
                    '</div>'+
                    '<div class="row">'+
                    '<div class="column">'+
                    '<div id="urlSegmentGroup" class="ui segments">'+
                    '<div id="responseHeaderHead" class="ui attached black inverted segment">'+
                    '<div class="ui medium header">Response Header</div></div>'+
                    renderResponseHeaders(urlCall.httpResponse.header)+'</div></div>'+
                    '<div class="column">'+
                    renderResponseContent(urlCall.httpResponse)+
                    '</div></div></div>';  
                                
                return output;
            }
            
            //Renders the individual response headers for a URL call
            function renderResponseHeaders(urlCall){
                var output = '';
                output += '<div id="headerSegment" class="ui attached segment">'+
                            '<b>'+urlCall[0]+'</b></div>';
                
                for (var i = 1; i<urlCall.length;++i){
                    if(typeof urlCall[i] !== 'undefined'){
                        var headerSplit = urlCall[i].split(": ");
                        output += '<div id="headerSegment" class="ui attached segment">'+
                            '<b>'+headerSplit[0]+': </b>'+headerSplit[1]+'</div>';
                    }
                    
                }
                
                return output;
            }
            
            //Renders the individual request headers for a URL call
            function renderRequestHeaders(urlCall){
                var output = '';
                
                for (var i = 0; i<urlCall.length;++i){
                    if(typeof urlCall[i] !== 'undefined'){
                        var headerSplit = urlCall[i].split(": ");
                        output += '<div id="headerSegment" class="ui attached segment">'+
                            '<b>'+headerSplit[0]+': </b>'+headerSplit[1]+'</div>';
                    }
                    
                }
                
                return output;
            }
            //Render the appropriate response according to the content type
            function renderContent(urlCall){
                var output = '';
                var contentType = urlCall.headerContentType
                
                
                if(typeof(contentType) == 'undefined'){
                    output='';
                }else if (contentType.includes("FONT-WOFF")){
                    output='';
                }else if (contentType.includes('IMAGE')){
                    output='<img src="data:'+contentType.toLowerCase()+';base64,'+urlCall.content+'">';
                }else{
                    output=urlCall.content;       
                }
                return output;
            }
            
            //Renders the responseContent
            function renderResponseContent(urlCall){
                var output='';
                
                if("content" in urlCall && urlCall.content.length>0){
                    output+='<div id="urlSegmentGroup" class="ui segments">'+
                    '<div id="requestContentHead" class="ui black inverted attached segment">'+
                    '<div class="ui medium header">Response Content</div>'+
                    '</div><div id="responseContentSegment" class="ui attached segment">'+
                        renderContent(urlCall)+
                        '</div></div>';
                }
                else{
                    output+='';
                }
                return output;
            }
            
            //Renders the requestContent
            function renderRequestContent(urlCall){
                var output='';
                
                if("content" in urlCall){
                    output+='<div class="column"><div id="urlSegmentGroup" class="ui segments">'+
                    '<div id="requestContentHead" class="ui yellow inverted attached segment">'+
                    '<div class="ui medium header">Request Content</div>'+
                    '</div><div id="requestContentSegment" class="ui attached segment">'+
                        byteToString(urlCall.content)+
                        '</div>'+'</div></div>';
                }
                else{
                    output+='';
                }
                return output;
            }
            
            //Converts bit array to String
            function byteToString(array){
                return String.fromCharCode.apply(null, array);
            }
            
        });
    </script>
    <script id="template" type="text/x-handlebars-template">
        {{#each proxyData}}
            {{#if httpPageBreak}}
                <div id="pageBreakSegment" class="ui segment">
                    <div class="ui fluid accordion">
                        <div class="title">{{httpPageBreak.comment}}</div>
                        <div class="content"></div>
                    </div>
                </div>
            {{/if}}
        {{/each}}
    </script>
    <script id="partial" type="text/x-handlebars-template">    
        {{#each proxyData}}
            {{#if httpRequest}}
                <div id="urlSegments" class="ui segments">
                    
                </div>
            {{/if}}
          {{/each}}
</script>
</body>
</html>