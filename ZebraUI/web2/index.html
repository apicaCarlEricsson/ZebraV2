<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/style.css" type="text/css">
    <link rel="stylesheet" href="/css/jquery-ui.min.css" type="text/css">
    <link rel="stylesheet" href="/css/jquery-ui.structure.min.css" type="text/css">
    <link rel="stylesheet" href="/css/jquery-ui.theme.min.css" type="text/css">
    <link rel="stylesheet" href="/semantic/dist/semantic.min.css" type="text/css">
    <title>ZebraTester</title>
</head>
<body>
   <div class="ui fluid container">
      <div class="ui hidden divider"></div>
       <div class="ui massive attached tabular menu">
           <div class="divider"></div>
             <div id="myLogo" class="ui middle aligned spaced large image">
              <img src="img/chameleonlogo.png">
            </div>
            <div id="statusNotifier" class="ui positive hidden message">
              <p></p>
            </div>
            <div class="right menu">
                <a class="active item" data-tab="build" data-vivaldi-spatnav-clickable="1">Build</a>
                <a class="item" data-tab="run" data-vivaldi-spatnav-clickable="1">Run</a>
                <a class="item" data-tab="analyze" data-vivaldi-spatnav-clickable="1">Analyze</a>
                <a class="item" data-tab="empty" data-vivaldi-spatnav-clickable="1"></a>
            </div>
       </div>
       <div class="ui bottom attached active tab segment" data-tab="build">
            <div class="ui menu">
                <div id="menuFileDropdown" class="ui dropdown link item">
                    <i class="list icon"></i>
                    <span class="text">Menu</span>
                    <div class="menu">
                        <div class="header">File</div>
                        <div id="newScriptButton" class="item"><span class="text">New script...</span></div>
                        <div id="openScriptButton" class="item">Open...</div>
                        <div id="saveScriptButton" class="item"><span class="text">Save</span></div>
                        <div id="saveAsScriptButton" class="item">Save as...</div>
                        <div id="saveAsToolbar" class="ui popup fluid wide"></div>
                        <div class="divider"></div>
                        <div class="header">Load Test</div>
                        <div class="item">Quick Test</div>
                        <div id="generateLoadTest" class="item">Generate Load Test</div>
                    </div>
                </div>
                <div class="ui dropdown link item">
                    <i class="book icon"></i>
                    <span class="text">View</span>
                    <div class="menu">
                        <div class="header">Panels</div>
                        <div id='toggleVarHandler' class="item"><span class="text">Toggle Var Handler</span></div>
                        <div id='toggleRecorder' class="item">Toggle Recorder</div>
                        <div class="item">Toggle Project Navigator</div>
                        <div class="divider"></div>
                        <div class="header">Display</div>
                        <div class="item">Original Item Numbers</div>
                        <div class="item">Current Item Numbers</div>
                        <div class="item">Runtime Configuration</div>
                        <div class="item">Item Offset</div>
                        <div class="item">Content Type</div>
                        <div class="item">Content Verification</div>
                    </div>
                </div>
                <div class="ui dropdown link item">
                    <i class="filter icon"></i>
                    <span class="text">Filter items</span>
                    <div class="menu">
                        <div class="header">Sort by</div>
                        <div class="item">Host</div>
                        <div class="item">Content Type</div>
                        <div class="item">Status Code</div>
                        <div class="divider"></div>
                        <div class="header">Exclude</div>
                        <div class="item">Static Content</div>
                        <div class="item">Cached Content</div>
                        <div class="divider"></div>
                        <div class="item">Clear Filter</div>
                    </div>
                </div>
                <div id="popupAnchor" class="ui hidden divider">
                </div>
                <div id="saveToolbar" class="ui popup fluid wide">
                            <h5 class="ui header">Save Dialog</h5>
                            <div class="ui input">
                                <input id="saveInput" type="text" placeholder="Add PageBreak...">
                            </div>
                            <div id="savePrxDat" class="link item">
                                Save
                            </div>
                </div>
                <div class="right menu">
                   <div id="recorderTrigger" class="link item">Recorder</div>
                   <div id="recorderToolbar" class="ui popup fluid wide">
                    <div class="ui menu">
                     <div id="record" class="link item">
                         Start Recording
                    </div>
                    <div id="pageBreaker" class="item">
                         <div class="ui input">
                            <input id="pageBreakerInput" type="text" placeholder="Add PageBreak...">
                          </div>
                    </div>
                    <div id="clearRecord" class="link item">
                         Clear Recording
                    </div>
                    </div>
                    </div>
                    <div class="item">
                         <div class="ui icon input">
                            <input type="text" placeholder="Search...">
                            <i class="search link icon"></i>
                          </div>
                    </div>
                </div>
            </div>
            <div id="listView" class="segment pushable">
                <div class="pusher">
                    <div id="metaDataView" class="ui basic segment">
                    </div>
                    <div id="pageBreakSegments" class="ui segments">
                    </div>
                </div>
                <div id="saveDialog" class="ui inverted labeled icon left inline vertical sidebar menu">
                    <div id="saveDialogChild" class="container">
                    <h5 id="saveAsLabel" class="ui header">Save As...</h5>
                    <div class="item"><div class="ui input">
                        <input id="savePrxDatInput" type="text" placeholder="Enter script name...">
                    </div>
                    </div>
                    <div id="savePrxDatAs" class="link item">
                        Save
                    </div>
                    </div>

            </div>

           </div>
   </div>
   <div class="ui bottom attached tab segment" data-tab="run">
            Run
        </div>
        <div class="ui bottom attached tab segment" data-tab="analyze">
            Analyze
        </div>
   </div>
    <script src="/js/jquery-3.1.1.min.js" type="application/javascript"></script>
    <script src="/js/jquery-ui.min.js" type="application/javascript"></script>
    <script src="/semantic/dist/semantic.min.js" type="application/javascript"></script>
    <script src="/js/finder.min.js" type="application/javascript"></script>
    <script src="/js/jquery.finder.js" type="application/javascript"></script>
    <script>
        $(document).ready(function(e) {
            $.ajax({url: "prxMetaData", success: function(result){
                if ("proxyData" in result){
                    $('#metaDataView').html(renderProjectMetaData(result));
                    $('#pageBreakSegments').html(renderList(result));
                    $('.ui.accordion').accordion({
                        duration: 500
                    });
                    var $toggle  = $('.ui.toggle.button');
                    $toggle.state({text: {inactive : 'S',active   : 'P'}});
                    $("div[id^='urlSegments']").sortable({
                        connectWith: "div#urlSegments.ui.segments",
                        placeholder: "ui-state-highlight",
                        handle: ".title"
                    });
                    $("div[id^='pageBreakSegments']").sortable({
                        connectWith: "div#pageBreakSegments.ui.segments",
                        placeholder: "ui-state-highlight",
                        handle: ".title"
                    });
                }

                //Handles sidebar
                $('.ui.sidebar')
                  .sidebar({
                    context: $('#listView'),
                    dimPage: false,
                    delaySetup: false,
                    transition: 'overlay'
                  });
            }});
            $.fn.toggleClick = function(){
                var methods = arguments, // store the passed arguments for future reference
                    count = methods.length; // cache the number of methods

                //use return this to maintain jQuery chainability
                return this.each(function(i, item){
                    // for each element you bind to
                    var index = 0; // create a local counter for that element
                    $(item).click(function(){ // bind a click handler to that element
                        return methods[index++ % count].apply(this,arguments); // that when called will apply the 'index'th method to that element
                        // the index % count means that we constrain our iterator between 0 and (count-1)
                    });
                });
            }

            //Trigger for saving script with specific name
            $("#saveAsScriptButton").click(function() {
                $('.ui.sidebar').sidebar('show');
            });

            //Save the script with a specific name
            $('#savePrxDatAs').click(function() {
                var saveAsName = $('#savePrxDatInput').val();
                console.log(saveAsName);
                if (saveAsName.length>0){
                    $.ajax({url: 'savePrxDat/'+saveAsName , success: function(result){
                        console.log('Script '+saveAsName+'.prxdat saved correctly');
                        statusUpdate('Script '+saveAsName+'.prxdat saved correctly');
                    }});
                    $('.ui.sidebar').sidebar('hide');
                }
            });

            //Open new script
            $("#openScriptButton").click(function (){
              var input = $(document.createElement('input'));
              input.attr("type", "file");
              input.trigger('click');
              input.on("change",function() {
                console.log("Change triggered");
                var filename=input.val().split("\\fakepath\\")[1];
                $.ajax({url:"openScript/"+filename, success:function(result){
                  console.log("Open script triggered");
                  statusUpdate("Script "+filename+" was opened");
                  refreshHttpList();
                }});
          		});
            });

            //Generate the script
            $("#generateLoadTest").click(function(){
              $.ajax({url:"generateLoadTest", success: function(result){
                console.log("Load test generated");
                statusUpdate("Load test generated");
              }});
            });

            //Save the script
            $( "#saveScriptButton" ).click(function() {
            $.ajax({url: "savePrxDat", success: function(result){
                  if(result.isSaved){
                      console.log("Script saved");
                      statusUpdate("Script saved");
                  }else{
                      $('.ui.sidebar').sidebar('show');
                  }
              }});
            });
            //Gives status update
            function statusUpdate (message){
              $("#statusNotifier > p").text(message);
              $("#statusNotifier").removeClass("hidden");
              $("#statusNotifier").show();
              $("#statusNotifier").delay(1000).fadeOut(3000);
            }

            //Clears the entire list
            function clearHTTPList () {
              $('#metaDataView').empty();
              $('#pageBreakSegments').empty();
            }

            //Refreshes the entire list again - usable after a change has been made on the java side
            function refreshHttpList (){
                $.ajax({url: "prxMetaData", success: function(result){
                if (typeof result.proxyData !== 'undefined' && result.proxyData !== null){
                    $('#metaDataView').html(renderProjectMetaData(result));
                    $('#pageBreakSegments').html(renderList(result));
                    $('.ui.accordion').accordion({
                        duration: 500
                    });
                    var $toggle  = $('.ui.toggle.button');
                    $toggle.state({text: {inactive : 'S',active   : 'P'}});
                    $("div[id^='urlSegments']").sortable({
                        connectWith: "div#urlSegments.ui.segments",
                        placeholder: "ui-state-highlight",
                        handle: ".title"
                    });
                    $("div[id^='pageBreakSegments']").sortable({
                        connectWith: "div#pageBreakSegments.ui.segments",
                        placeholder: "ui-state-highlight",
                        handle: ".title"
                    });
                }
                //Handles sidebar
                $('.ui.sidebar')
                  .sidebar({
                    context: $('#listView'),
                    dimPage: false,
                    delaySetup: false,
                    closable: false,
                    transition: 'overlay'
                  });

                }});}

            //Handles toggling of the recorder
            $('#record').toggleClick(function(){
                $(this).addClass('recording');
                $(this).text('Stop Recording');
                $.ajax({url:'startRecording', success: function(result){
                    statusUpdate("Recording started successfully");
                    console.log("Recording started successfully");
                }});
            },function(){
                $(this).removeClass('recording');
                $(this).text('Start Recording');
                $.ajax({url:'stopRecording', success: function(result){
                    refreshHttpList();
                    statusUpdate("Recording stopped successfully");
                    console.log("Recording stopped successfully");
                }});
            });

            //Clears recording
            $('#clearRecord').click(function(){
                $.ajax({url:'clearRecording', success: function(result){
                    statusUpdate("Recording cleared successfully");
                    console.log("Recording cleared successfully");
                    clearHTTPList();
                }});
            });

            //Adds page breaks via the recorder
            $('#pageBreakerInput').keypress(function (e) {
                  if (e.which == 13) {
                    $.ajax({url:'addPageBreakRec/'+$('#pageBreakerInput').val(), success: function(result){
                        console.log('Page Break '+$('#pageBreakerInput').val()+' created successfully');
                        statusUpdate('Page Break '+$('#pageBreakerInput').val()+' created successfully');
                        refreshHttpList();
                    }});
                    return false;
                  }
                });

            //Trigger for the recorder popup
            $('#recorderTrigger')
              .popup({
                popup : $('#recorderToolbar'),
                on    : 'click',
                position : 'bottom right'
              });

            $('#saveScriptButton')
              .popup({
                popup : $('#saveToolbar'),
                on    : 'click',
                target: '#popupAnchor',
                position : 'bottom left'
              });

            $('.right.menu .item').tab();
            $('.dropdown').dropdown({action: 'select'});

            //Render the metaData of the Project
            function renderProjectMetaData(result){
                var output;

                output='<div class="ui grid">'+
                    '<div class="ten wide column"><h3 id="projectNameLabel" class="ui left aligned header">'+result.projectName+
                    '<div class="sub header">Script Name</div></h3></div>'+
                    '<div class="two wide column"><h3 id="projectURLCount" class="ui center aligned header">'+
                    countURLCalls(result)+
                    '<div class="sub header">Number of<br>URL calls</div></h3></div>'+
                    '<div class="two wide column"><h3 id="projectSentSize" class="ui center aligned header">'+
                    calculateTotalRequestSize(result)+
                    '<div class="sub header">Total Size<br> Sent</div></h3></div>'+
                    '<div class="two wide column"><h3 id="projectRecievedSize" class="ui center aligned header">'+
                    calculateTotalResponseSize(result)+
                    '<div class="sub header">Total Size<br> Recieved</div></h3></div>'+
                    '</div>'

                return output;
            }

            //Counts number of URL calls
            function countURLCalls(result){
                var count=0;

                for(var i = 0; i<result.proxyData.length; ++i){
                    var record=result.proxyData[i];
                    if ("httpRequest" in record){
                        count=count+1;
                    }

                }

                return count;
            }


            //Selects the correct label for content type
            function pickContentLabel (contentType){
                var label;
                if(typeof contentType === 'undefined'){
                   label='<div id="contentTypeLabel" class="ui medium black label">N/A</div>';
                }else if (contentType.includes('TEXT/HTML')){
                    label='<div id="contentTypeLabel" class="ui medium blue label">HTML</div>';
                }else if (contentType.includes('TEXT/CSS')){
                    label='<div id="contentTypeLabel" class="ui medium red label">CSS</div>';
                }else if (contentType.includes('APPLICATION/X-JAVASCRIPT')|| contentType.includes('APPLICATION/JAVASCRIPT')){
                    label='<div id="contentTypeLabel" class="ui medium olive label">JS</div>';
                }else if (contentType.includes('APPLICATION/JSON')){
                    label='<div id="contentTypeLabel" class="ui medium green label">JSON</div>';
                }else if (contentType.includes('IMAGE')){
                    label='<div id="contentTypeLabel" class="ui medium orange label">IMAGE</div>';
                }else{
                    label='<div id="contentTypeLabel" class="ui medium grey label">OTHER</div>';
                }
                return label;
            }

            //Chooses the correct HTTP Response code
            function pickStatusCode(statusCode, statusMessage){
                var statusLabel = '<b>'+statusCode+' '+statusMessage+'</b>';
                return statusLabel;
            }

            //Renders the list of URL calls and page breaks
            function renderList (data){
                var html='';
                var dataArray = data.proxyData;

                for (var i = 0; i < dataArray.length;++i){
                    var proxyRecord = dataArray[i];

                    if ('httpPageBreak' in proxyRecord){
                        if (i>0){
                            html += '</div></div></div></div>';
                        }
                        html += '<div id="pageBreakSegment'+i+'" pageBreakID="'+ i +
                            '" class="ui segment">'+'<div class="ui fluid accordion">'+
                        '<div class="title">'+proxyRecord.httpPageBreak.comment+'</div>'+
                        '<div class="content"><div id="urlSegments" class="ui segments">';
                    }
                    else{
                        html += '<div id="urlSegment"urlID="'+i+'" class="ui segment">'+
                            '<div class="item"><button id="serialParallelButton" class="ui tiny right floated toggle button">S</button></div>'+
                            '<div class="item" id="urlSizeText"><b>'+calculatePageSize(proxyRecord.httpResponse.headerContentLength)+'</b></div>'+
                            '<div class="accordion" urlIDAccordion="'+i+'">'+
                            '<div class="title">'+
                            pickContentLabel(proxyRecord.httpResponse.headerContentType)+
                            pickStatusCode(proxyRecord.httpResponse.headerServerStatus, proxyRecord.httpResponse.headerServerStatusText)+
                            ' '+
                            proxyRecord.httpRequest.urlProtocol+
                            '://'+proxyRecord.httpRequest.urlHost+proxyRecord.httpRequest.urlFile+'</div>'+'<div class="content">'+
                            renderURLCall(proxyRecord, i)+
                            '</div>'+
                            '</div></div>';


                    }

                }
                html += '</div></div></div></div>';
                return html;
            }

            //Calculates the totalResponseSize
            function calculateTotalResponseSize(result){
                var contentSize=0;

                for (var i = 0; i<result.proxyData.length; ++i){
                    var record = result.proxyData[i];
                    if ("httpResponse" in record){
                        contentSize=contentSize+record.httpResponse
                            .headerContentLength;
                    }
                }

                return calculatePageSize(contentSize);
            }

            //Calculates the totalRequestSize
            function calculateTotalRequestSize(result){
                var contentSize=0;

                for (var i = 0; i<result.proxyData.length; ++i){
                    var record = result.proxyData[i];
                    if ("httpRequest" in record){
                        contentSize=contentSize+record.httpRequest
                            .requestTransmitSize;
                    }
                }

                return calculatePageSize(contentSize);
            }

            //Calculates the response content size
            function calculatePageSize(headerContentLength){

                var sizeB=headerContentLength;
                var sizeKB = headerContentLength/1024;
                var sizeMB = sizeKB/1024;

                if (sizeKB>1024){
                    return Math.round(sizeMB * 10)/10 + ' MB';
                }else if(sizeKB<1){
                    return Math.round(sizeB * 10)/10 + ' B';
                }else{
                    return Math.round(sizeKB * 10)/10 + ' KB';
                }
            }

            //Renders individual data for URL call
            function renderURLCall (urlCall, index){
                var output='';

                output+='<div class="ui two column grid">'+
                    '<div class="row">'+
                    '<div class="column">'+
                    '<div id="urlSegmentGroup" class="ui segments">'+
                    '<div id="requestHeaderHead" class="ui attached yellow inverted segment">'+
                    '<div class="ui medium header">Request Header</div></div>'+
                    renderRequestHeaders(urlCall.httpRequest.header)+'</div></div>'+
                    renderRequestContent(urlCall.httpRequest)+
                    '</div>'+
                    '<div class="row">'+
                    '<div class="column">'+
                    '<div id="urlSegmentGroup" class="ui segments">'+
                    '<div id="responseHeaderHead" class="ui attached black inverted segment">'+
                    '<div class="ui medium header">Response Header</div></div>'+
                    renderResponseHeaders(urlCall.httpResponse.header)+'</div></div>'+
                    '<div class="column">'+
                    renderResponseContent(urlCall.httpResponse)+
                    '</div></div></div>';

                return output;
            }

            //Renders the individual response headers for a URL call
            function renderResponseHeaders(urlCall){
                var output = '';
                output += '<div id="headerSegment" class="ui attached segment">'+
                            '<b>'+urlCall[0]+'</b></div>';

                for (var i = 1; i<urlCall.length;++i){
                    if(typeof urlCall[i] !== 'undefined'){
                        var headerSplit = urlCall[i].split(": ");
                        output += '<div id="headerSegment" class="ui attached segment">'+
                            '<b>'+headerSplit[0]+': </b>'+headerSplit[1]+'</div>';
                    }

                }

                return output;
            }

            //Renders the individual request headers for a URL call
            function renderRequestHeaders(urlCall){
                var output = '';

                for (var i = 0; i<urlCall.length;++i){
                    if(typeof urlCall[i] !== 'undefined'){
                        var headerSplit = urlCall[i].split(": ");
                        output += '<div id="headerSegment" class="ui attached segment">'+
                            '<b>'+headerSplit[0]+': </b>'+headerSplit[1]+'</div>';
                    }

                }

                return output;
            }
            //Render the appropriate response according to the content type
            function renderContent(urlCall){
                var output = '';
                var contentType = urlCall.headerContentType


                if(typeof(contentType) == 'undefined'){
                    output='';
                }else if (contentType.includes("FONT-WOFF")){
                    output='';
                }else if (contentType.includes('IMAGE')){
                    output='<img src="data:'+contentType.toLowerCase()+';base64,'+urlCall.content+'">';
                }else{
                    output=urlCall.content;
                }
                return output;
            }

            //Renders the responseContent
            function renderResponseContent(urlCall){
                var output='';

                if("content" in urlCall && urlCall.content.length>0){
                    output+='<div id="urlSegmentGroup" class="ui segments">'+
                    '<div id="requestContentHead" class="ui black inverted attached segment">'+
                    '<div class="ui medium header">Response Content</div>'+
                    '</div><div id="responseContentSegment" class="ui attached segment">'+
                        renderContent(urlCall)+
                        '</div></div>';
                }
                else{
                    output+='';
                }
                return output;
            }

            //Renders the requestContent
            function renderRequestContent(urlCall){
                var output='';

                if("content" in urlCall){
                    output+='<div class="column"><div id="urlSegmentGroup" class="ui segments">'+
                    '<div id="requestContentHead" class="ui yellow inverted attached segment">'+
                    '<div class="ui medium header">Request Content</div>'+
                    '</div><div id="requestContentSegment" class="ui attached segment">'+
                        byteToString(urlCall.content)+
                        '</div>'+'</div></div>';
                }
                else{
                    output+='';
                }
                return output;
            }

            //Converts bit array to String
            function byteToString(array){
                return String.fromCharCode.apply(null, array);
            }

        });
    </script>
</body>
</html>
